{% extends "layout.html" %}

{% block title %}
    My Session
{% endblock %}
{% block main %}
<div class="card text-center" style="max-width: 320px; margin: 0 auto; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0);">
    <h1 class="card-title">Set Timer for your Session/Break</h1>

    <div class="inputs d-flex justify-content-center gap-2 mb-2">
        <div>
            <label for="minutes">Minutes</label><br>
            <input id="minutes" type="number" min="0" value="0" class="form-control form-control-sm" style="width: 70px; text-align: center;">
        </div>
        <div>
            <label for="seconds">Seconds</label><br>
            <input id="seconds" type="number" min="0" max="59" value="30" class="form-control form-control-sm" style="width: 70px; text-align: center;">
        </div>
    </div>

    <div class="display mb-2" id="display" style="font-size: 24px; font-weight: 600;">00:30</div>

    <div class="controls d-flex justify-content-center gap-2 mb-2">
        <button id="startBtn" class="btn btn-primary btn-sm">Start</button>
        <button id="pauseBtn" class="btn btn-secondary btn-sm" disabled>Pause</button>
        <button id="resetBtn" class="btn btn-outline-secondary btn-sm" disabled>Reset</button>
    </div>

    <div class="d-flex justify-content-center gap-2">
        <label class="form-check-label"><input id="soundToggle" type="checkbox" checked class="form-check-input me-1"> Sound</label>
        <label class="form-check-label"><input id="spaceToggle" type="checkbox" checked class="form-check-input me-1"> Space</label>
    </div>
</div>

<script defer>
    (function () {
        const minutesInput = document.getElementById('minutes');
        const secondsInput = document.getElementById('seconds');
        const display = document.getElementById('display');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const soundToggle = document.getElementById('soundToggle');
        const spaceToggle = document.getElementById('spaceToggle');

        let totalSeconds = parseInt(secondsInput.value) + parseInt(minutesInput.value || 0) * 60;
        let remaining = totalSeconds;
        let intervalId = null;
        let running = false;
        let finished = false;

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
        }

        function updateDisplay() {
            display.textContent = formatTime(remaining);
        }

        function readInputs() {
            const m = Math.max(0, parseInt(minutesInput.value || 0));
            let s = Math.max(0, parseInt(secondsInput.value || 0));
            if (s > 59) s = 59;
            totalSeconds = m * 60 + s;
            remaining = totalSeconds;
            updateDisplay();
        }

        function tick() {
            if (remaining <= 0) {
                stopInterval();
                finished = true;
                running = false;
                onFinish();
                return;
            }
            remaining -= 1;
            updateDisplay();
        }

        function startInterval() {
            if (intervalId) return;
            intervalId = setInterval(tick, 1000);
            running = true;
            pauseBtn.textContent = 'Pause';
            pauseBtn.disabled = false;
            resetBtn.disabled = false;
            startBtn.disabled = true;
        }

        function stopInterval() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }

        function pauseTimer() {
            stopInterval();
            running = false;
            pauseBtn.textContent = 'Resume';
        }

        function resumeTimer() {
            if (finished) return;
            startInterval();
        }

        function resetTimer() {
            stopInterval();
            readInputs();
            running = false;
            finished = false;
            pauseBtn.disabled = true;
            pauseBtn.textContent = 'Pause';
            startBtn.disabled = false;
            resetBtn.disabled = true;
        }

        function onFinish() {
            display.textContent = '00:00';
            pauseBtn.disabled = true;
            startBtn.disabled = false;
            if (soundToggle.checked) playBeep();
        }

        function playBeep() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = 'sine';
                o.frequency.value = 880;
                g.gain.setValueAtTime(0.0001, ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
                o.connect(g);
                g.connect(ctx.destination);
                o.start();
                setTimeout(() => {
                    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.15);
                    setTimeout(() => {
                        o.stop();
                        ctx.close();
                    }, 200);
                }, 300);
            } catch (e) {}
        }

        minutesInput.addEventListener('input', readInputs);
        secondsInput.addEventListener('input', readInputs);

        startBtn.addEventListener('click', () => {
            if (finished) {
                resetTimer();
            }
            if (remaining <= 0) readInputs();
            if (remaining <= 0) return;
            startInterval();
        });

        pauseBtn.addEventListener('click', () => {
            if (!running) {
                resumeTimer();
            } else {
                pauseTimer();
            }
        });

        resetBtn.addEventListener('click', resetTimer);

        window.addEventListener('keydown', (e) => {
            if (spaceToggle.checked && e.code === 'Space' && document.activeElement.tagName !== 'INPUT') {
                e.preventDefault();
                if (!running && !finished && (remaining > 0)) {
                    if (!intervalId) {
                        startInterval();
                    } else {
                        resumeTimer();
                    }
                } else if (running) {
                    pauseTimer();
                } else if (finished) {
                    resetTimer();
                }
            }
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
                e.preventDefault();
                resetTimer();
            }
        });

        readInputs();
    })();
</script>
{% endblock %}