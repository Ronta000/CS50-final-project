{% extends "layout.html" %}

{% block title %}
    Quiz
{% endblock %}

{% block main %}

  <h1>Quiz Mode</h1>
  <button onclick="startQuiz()">Start Quiz</button>
  <div id="quiz"></div>
  <button id="submitBtn" style="display:none;" onclick="submitQuiz()">Submit Quiz</button>
  <div id="result"></div>

  <script>
    function normalize(str) {
      return str.trim().toLowerCase().replace(/\s+/g, ' ');
  }
    async function startQuiz() {
    let quizDiv = document.getElementById("quiz");
    quizDiv.innerHTML = "<p>Loading your flashcards...</p>";

    let response = await fetch("/get_flashcards");
    let flashcards = await response.json();

    if (!Array.isArray(flashcards) || flashcards.length < 5) {
        alert("You need at least 5 flashcards to start the quiz.");
        return;
    }

    flashcards = flashcards.sort(() => Math.random() - 0.5);

    quizDiv.innerHTML = "";

    flashcards.forEach((q, index) => {
        quizDiv.innerHTML += `
            <div>
                <p>${index + 1}. ${q.question}</p>
                <input type="text" id="answer${index}" placeholder="Your answer">
            </div>
        `;
    });

    window.currentQuiz = flashcards;
    document.getElementById("submitBtn").style.display = "block";
    document.getElementById("result").innerHTML = "";
}

    function submitQuiz() {
      if (!window.currentQuiz) {
        alert("Please start the quiz first!");
        return;
      }

      let score = 0;
      let questions = window.currentQuiz;
      let resultHTML = "<ul>";

      for (let i = 0; i < questions.length; i++) {
      let ans = document.getElementById("answer" + i).value.trim();
      if (ans === "") {

        alert(`Please fill in all answers before submitting! (Question ${i + 1} is empty)`);
          return;
        }
}
     

      questions.forEach((q, index) => {
        let userAnswer = normalize(document.getElementById("answer" + index).value);
        let correctAnswer = normalize(q.answer);

        if (userAnswer === correctAnswer) {
          score++;
          resultHTML += `<li>Question ${index + 1}: Correct! Your answer: "${userAnswer}"</li>`;
        } else {
          resultHTML += `<li>Question ${index + 1}: Wrong. Your answer: "${userAnswer}", Correct: "${correctAnswer}"</li>`;
        }
      });

      resultHTML += `</ul><h2>Total Score: ${score} / ${questions.length}</h2>`;
      document.getElementById("result").innerHTML = resultHTML;
    }
  </script>
  <style>
</style>
{% endblock %}