{% extends "layout.html" %}

{% block title %}
    Smartly Customized Session
{% endblock %}

{% block main %}

<div class="main">
    <h1 style="color:blue">FocusHive</h1>
    <div class="timer-circle" id="timer">25:00</div>
    <div class="control-buttons" id="controlButtons">
        <button onclick="togglePauseResume()">Start</button>
        <button onclick="restartTimer()">Restart</button>
    </div>
    <div class="break-button" id="breakButton" style="display: none;">
        <button onclick="window.location.href='/breaks'">Take a Break</button>
    </div>
</div>
<style>
.main {
    background-color: #fff;
    border-radius: 15px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
    padding: 10px 20px;
    transition: transform 0.2s;
    width: 500px;
    height: 400px;
    text-align: center;
    margin: 0 auto;
}

.timer-circle {
    border-radius: 50%;
    width: 200px;
    height: 200px;
    margin: 20px auto;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 25px;
    color: crimson;
    border: 8px solid #3498db;
}

.control-buttons {
    margin-top: 75px;
    display: flex;
    justify-content: space-evenly;
}

.control-buttons button {
    background-color: #3498db;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
}

.control-buttons button:hover {
    background-color: #266094;
    transition: background-color 0.3s;
}

.break-button {
    margin-top: 20px;
}

.break-button button {
    background-color: #e74c3c;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
}

.break-button button:hover {
    background-color: #c0392b;
    transition: background-color 0.3s;
}
</style>
<script>
let timer;
let minutes = 25;
let seconds = 0;
let isPaused = true;
let enteredTime = null;
let sessionStart = null;

const savedStart = sessionStorage.getItem("sessionStart");

if (savedStart) {
    sessionStart = new Date(savedStart);
    const elapsedSeconds = Math.floor((Date.now() - sessionStart.getTime()) / 1000);
    const totalSeconds = 15 * 60;
    const remaining = totalSeconds - elapsedSeconds;

    if (remaining > 0) {
        minutes = Math.floor(remaining / 60);
        seconds = remaining % 60;
        isPaused = false;
        startTimer();
    } else {
        minutes = 0;
        seconds = 0;
        alert('Time is up! Take a break.');
    }
}


function startTimer() {
    if (timer) clearInterval(timer);
    timer = setInterval(updateTimer, 1000);
}

function updateTimer() {
    const timerElement = document.getElementById('timer');
    const controlButtons = document.getElementById('controlButtons');
    const breakButton = document.getElementById('breakButton');
    
    if (isPaused) {
        timerElement.textContent = formatTime(minutes, seconds);
        return;
    }
    
    if (minutes === 0 && seconds === 0) {
        clearInterval(timer);
        alert('Time is up! Take a break.');
        isPaused = true;
        controlButtons.style.display = 'none';
        breakButton.style.display = 'block';
        return;
    }
    
    if (seconds === 0) {
        if (minutes > 0) {
            minutes--;
            seconds = 59;
        }
    } else {
        seconds--;
    }
    
    if (minutes === 0 && seconds === 0) {
        clearInterval(timer);
        alert('Time is up! Take a break.');
        isPaused = true;
        controlButtons.style.display = 'none';
        breakButton.style.display = 'block';
    }
    
    timerElement.textContent = formatTime(minutes, seconds);
}

function formatTime(minutes, seconds) {
    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function togglePauseResume() {
    const pauseResumeButton = document.querySelector('#controlButtons button');
    isPaused = !isPaused;

    if (isPaused) {
        clearInterval(timer);
        pauseResumeButton.textContent = 'Resume';
    } else {
        startTimer();
        pauseResumeButton.textContent = 'Pause';
    }
}

function restartTimer() {
    clearInterval(timer);
    minutes = enteredTime || 25;
    seconds = 0;
    isPaused = true;
    const timerElement = document.getElementById('timer');
    timerElement.textContent = formatTime(minutes, seconds);
    const pauseResumeButton = document.querySelector('#controlButtons button');
    pauseResumeButton.textContent = 'Start';
    const controlButtons = document.getElementById('controlButtons');
    const breakButton = document.getElementById('breakButton');
    controlButtons.style.display = 'flex';
    breakButton.style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('timer').textContent = formatTime(minutes, seconds);
});



function togglePauseResume() {
    const pauseResumeButton = document.querySelector('#controlButtons button');
    isPaused = !isPaused;

    if (isPaused) {
        clearInterval(timer);
        pauseResumeButton.textContent = 'Resume';
    } else {
        if (!sessionStart) sessionStart = new Date(); 
        sessionStorage.setItem("sessionStart", sessionStart.toISOString());
        startTimer();
        pauseResumeButton.textContent = 'Pause';
    }
}

function endSession() {
    const end = new Date();
    sessionStorage.removeItem("sessionStart");
    const duration = Math.round(((end - sessionStart) / 1000) / 60);
    const date = end.toISOString().split("T")[0];


    fetch("/customizedsession", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            start_time: sessionStart.toISOString(),
            end_time: end.toISOString(),
            duration: duration,
            date: date 
        })
    }).then(res => res.json())
      .then(data => console.log(data))
      .catch(err => console.error(err));
}

let lastUpdate = Date.now();

function updateTimer() {
    const timerElement = document.getElementById('timer');
    const controlButtons = document.getElementById('controlButtons');
    const breakButton = document.getElementById('breakButton');

    if (isPaused) {
        lastUpdate = Date.now();
        timerElement.textContent = formatTime(minutes, seconds);
        return;
    }

    const now = Date.now();
    const delta = Math.floor((now - lastUpdate) / 1000); 
    if (delta > 0) {
        const totalSeconds = minutes * 60 + seconds - delta;
        minutes = Math.floor(totalSeconds / 60);
        seconds = totalSeconds % 60;
        lastUpdate = now;
    }

    if (minutes <= 0 && seconds <= 0) {
        clearInterval(timer);
        alert('Time is up! Take a break.');
        isPaused = true;
        controlButtons.style.display = 'none';
        breakButton.style.display = 'block';
        endSession();
        return;
    }

    timerElement.textContent = formatTime(Math.max(minutes, 0), Math.max(seconds, 0));
}
body: JSON.stringify({
    start_time: sessionStart.toISOString(),
    end_time: end.toISOString(),
    duration: duration
})

</script>
{% endblock %}