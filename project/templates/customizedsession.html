{% extends "layout.html" %}

{% block title %}
    Smartly Customized Session
{% endblock %}

{% block main %}

<div class="main">
    <h1 style="color:rgb(0, 102, 255)">FocusHive</h1>
    <div class="timer-circle" id="timer">25:00</div>
    <div class="control-buttons" id="controlButtons">
        <button onclick="togglePauseResume()">Start</button>
        <button onclick="restartTimer()">Restart</button>
    </div>
    <div class="break-button" id="breakButton" style="display: none;">
        <button onclick="window.location.href='/breaks'">Take a Break</button>
    </div>
</div>
<style>
.main {
    background-color: #fff;
    border-radius: 15px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
    padding: 10px 20px;
    transition: transform 0.2s;
    width: 500px;
    height: 400px;
    text-align: center;
    margin: 0 auto;
}

.timer-circle {
    border-radius: 50%;
    width: 200px;
    height: 200px;
    margin: 20px auto;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 25px;
    color: rgb(20, 50, 220);
    border: 8px solid #34db58;
}

.control-buttons {
    margin-top: 75px;
    display: flex;
    justify-content: space-evenly;
}

.control-buttons button {
    background-color: #db7f34;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
}

.control-buttons button:hover {
    background-color: #3748e6;
    transition: background-color 0.3s;
}

.break-button {
    margin-top: 20px;
}

.break-button button {
    background-color: #e74c3c;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
}

.break-button button:hover {
    background-color: #c0392b;
    transition: background-color 0.3s;
}
</style>
<script>
const TIMER_DEFAULT_MINUTES = 25; 

let timerInterval = null;
let totalInitSeconds = TIMER_DEFAULT_MINUTES * 60;
let sessionStart = null;      
let pausedAccum = 0;          
let pausedAt = null;          
let isRunning = false;        

function loadState() {
    const sStart = sessionStorage.getItem("sessionStart");
    const sTotal = sessionStorage.getItem("totalInitSeconds");
    const sPausedAccum = sessionStorage.getItem("pausedAccum");
    const sPausedAt = sessionStorage.getItem("pausedAt");

    if (sTotal) totalInitSeconds = parseInt(sTotal, 10);
    if (sStart) sessionStart = new Date(sStart);
    if (sPausedAccum) pausedAccum = parseInt(sPausedAccum, 10);
    if (sPausedAt) pausedAt = new Date(sPausedAt);
}
function saveState() {
    if (sessionStart) sessionStorage.setItem("sessionStart", sessionStart.toISOString());
    else sessionStorage.removeItem("sessionStart");

    sessionStorage.setItem("totalInitSeconds", String(totalInitSeconds));
    sessionStorage.setItem("pausedAccum", String(pausedAccum));
    if (pausedAt) sessionStorage.setItem("pausedAt", pausedAt.toISOString());
    else sessionStorage.removeItem("pausedAt");
}
function clearState() {
    sessionStorage.removeItem("sessionStart");
    sessionStorage.removeItem("totalInitSeconds");
    sessionStorage.removeItem("pausedAccum");
    sessionStorage.removeItem("pausedAt");
}
function formatTime(totalSeconds) {
    if (totalSeconds < 0) totalSeconds = 0;
    const m = Math.floor(totalSeconds / 60);
    const s = Math.floor(totalSeconds % 60);
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function computeRemainingSeconds() {
    if (!sessionStart) return totalInitSeconds;
    const now = Date.now();
    const elapsedMs = now - sessionStart.getTime() - pausedAccum;
    const elapsedSec = Math.floor(elapsedMs / 1000);
    return totalInitSeconds - elapsedSec;
}
function updateUI(remainingSec) {
    const timerEl = document.getElementById('timer');
    const controlBtns = document.getElementById('controlButtons');
    const breakBtn = document.getElementById('breakButton');

    timerEl.textContent = formatTime(remainingSec);

    if (remainingSec <= 0) {
        clearInterval(timerInterval);
        timerInterval = null;
        isRunning = false;
        controlBtns.style.display = 'none';
        breakBtn.style.display = 'block';
        timerEl.textContent = "00:00";
        endSession();
    } else {
        controlBtns.style.display = 'flex';
        breakBtn.style.display = 'none';
    }
}
function startIntervalIfNeeded() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        if (!isRunning) return;
        const remaining = computeRemainingSeconds();
        updateUI(remaining);
    }, 1000);
}
function togglePauseResume() {
    const btn = document.querySelector('#controlButtons button');
    if (!sessionStart) {
        sessionStart = new Date();
        pausedAccum = 0;
        pausedAt = null;
        totalInitSeconds = TIMER_DEFAULT_MINUTES * 60;
        isRunning = true;
        btn.textContent = 'Pause';
        saveState();
        startIntervalIfNeeded();
        updateUI(computeRemainingSeconds());
        return;
    }
    if (!isRunning) {
        if (pausedAt) {
            pausedAccum += (Date.now() - pausedAt.getTime());
            pausedAt = null;
        }
        isRunning = true;
        btn.textContent = 'Pause';
        saveState();
        startIntervalIfNeeded();
        updateUI(computeRemainingSeconds());
        return;
    }
    if (isRunning) {
        pausedAt = new Date();
        isRunning = false;
        btn.textContent = 'Resume';
        saveState();
    }
}
function restartTimer() {
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    sessionStart = null;
    pausedAccum = 0;
    pausedAt = null;
    isRunning = false;
    totalInitSeconds = TIMER_DEFAULT_MINUTES * 60;
    clearState();
    document.getElementById('timer').textContent = formatTime(totalInitSeconds);
    const btn = document.querySelector('#controlButtons button');
    btn.textContent = 'Start';
    document.getElementById('controlButtons').style.display = 'flex';
    document.getElementById('breakButton').style.display = 'none';
}
function endSession() {
    if (!sessionStart) return;
    const end = new Date();
    let elapsedMs = end.getTime() - sessionStart.getTime() - pausedAccum;
    if (elapsedMs < 0) elapsedMs = 0;
    const durationMinutes = Number((elapsedMs / 1000 / 60).toFixed(2));

    clearState();

    fetch("/customizedsession", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            start_time: sessionStart.toISOString(),
            end_time: end.toISOString(),
            duration: durationMinutes,
            date: end.toISOString().split("T")[0]
        })
    })
    .then(res => res.json().catch(()=>{}))
    .then(() => console.log("Session sent:", durationMinutes, "minutes"))
    .catch(err => console.error("Error saving session:", err));

    sessionStart = null;
    pausedAccum = 0;
    pausedAt = null;
    isRunning = false;
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
}
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    if (pausedAt) {
        isRunning = false;
        document.querySelector('#controlButtons button').textContent = 'Resume';
    } else if (sessionStart) {
        const rem = computeRemainingSeconds();
        if (rem > 0) {
            isRunning = true;
            document.querySelector('#controlButtons button').textContent = 'Pause';
            startIntervalIfNeeded();
        } else {
            sessionStart = null;
            pausedAccum = 0;
            clearState();
            document.querySelector('#controlButtons button').textContent = 'Start';
        }
        updateUI(Math.max(computeRemainingSeconds(), 0));
    } else {
        document.getElementById('timer').textContent = formatTime(totalInitSeconds);
        document.querySelector('#controlButtons button').textContent = 'Start';
    }
});
</script>

{% endblock %}