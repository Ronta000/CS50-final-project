{% extends "layout.html" %}

{% block title %}
    Smartly Customized Session
{% endblock %}

{% block main %}
   <h1 class="fh-title">FocusHive</h1>

<div class="fh-wrapper">
  <div class="fh-card">
    <div class="timer-circle" id="timer" aria-live="polite">25:00</div>

    <div class="control-buttons" role="group" aria-label="Timer controls">
      <button id="startPauseBtn" type="button">Start</button>
      <button id="restartBtn" type="button">Restart</button>
    </div>

    <div class="next-link-row" style="margin-top:12px; width:100%; text-align:center;">
      <button id="goBtn" disabled style="display:none; margin-left:8px;">Go to next page</button>
    </div>

  </div>
</div>

<script>
(() => {
  const DEFAULT_MINUTES = 25;
  const DURATION_MS = DEFAULT_MINUTES * 60 * 1000;
  let remainingMs = DURATION_MS;
  let startTimestamp = null;
  let startISO = null;
  let timerId = null;            
  let running = false;
  let paused = false;

  const timerEl = document.getElementById('timer');
  const startPauseBtn = document.getElementById('startPauseBtn');
  const restartBtn = document.getElementById('restartBtn');
  const goBtn = document.getElementById('goBtn');

  function fmt(ms) {
    const secs = Math.ceil(ms / 1000); 
    const m = Math.floor(secs / 60);
    const s = secs % 60;
    return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
  }

  function updateTimerUI() {
    if (!running) {
      timerEl.textContent = fmt(remainingMs);
      return;
    }
    const now = Date.now();
    const elapsed = now - startTimestamp;
    const left = Math.max(0, remainingMs - elapsed);

    if (left <= 0) {
      clearIntervalSafely();
      running = false;
      paused = false;
      remainingMs = 0;
      timerEl.textContent = '00:00';
      startPauseBtn.textContent = 'Start';
      onTimeUp();
      return;
    }

    timerEl.textContent = fmt(left);
  }

  function clearIntervalSafely() {
    if (timerId !== null) {
      clearInterval(timerId);
      timerId = null;
    }
  }

  function startTimer() {
    if (running) return;
    startTimestamp = Date.now();
    startISO = new Date(startTimestamp).toISOString();
    running = true;
    paused = false;
    updateTimerUI();
    clearIntervalSafely();
    timerId = setInterval(updateTimerUI, 1000);
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission().catch(()=>{});
    }
  }

  function pauseTimer() {
    if (!running) return;
    const now = Date.now();
    const elapsed = now - startTimestamp;
    remainingMs = Math.max(0, remainingMs - elapsed);
    clearIntervalSafely();
    running = false;
    paused = true;
    startPauseBtn.textContent = 'Resume';
    updateTimerUI();
  }

  function resumeTimer() {
    if (running) return;
    startTimer();
    startPauseBtn.textContent = 'Pause';
  }

  function restartTimer() {
    clearIntervalSafely();
    remainingMs = DURATION_MS;
    running = false;
    paused = false;
    startTimestamp = null;
    startISO = null;
    timerEl.textContent = fmt(remainingMs);
    startPauseBtn.textContent = 'Start';
    goBtn.style.display = 'none';
    goBtn.disabled = true;
  }

  function onTimeUp() {
    playBeep();
    goBtn.style.display = 'inline-block';
    goBtn.disabled = false;

     try {
      const endISO = new Date().toISOString();
      const durationMs = Date.now() - (startTimestamp || Date.now());
      const durationMinutes = Math.max(1, Math.round(durationMs / 60000)); 

      const payload = {
        start_time: startISO || new Date(Date.now() - durationMs).toISOString(),
        end_time: endISO,
        duration: durationMinutes,
        date: new Date().toISOString().slice(0,10)
      };

      fetch('/customizedsession', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(res => {
        if (!res.ok) console.warn('Failed to save session', res.status);
      }).catch(err => console.error('Error saving session', err));
    } catch(e) {
      console.error(e);
    }

    if ('Notification' in window && Notification.permission === 'granted') {
      try {
        new Notification('FocusHive', { body: "Time's up! Take a break." });
      } catch (e) {}
    } else {
      try { alert("Time's up! Take a break."); } catch(e){}
    }
  }
  
function playBeep() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine';
      o.frequency.value = 880;
      g.gain.value = 0.0001;
      o.connect(g);
      g.connect(ctx.destination);
      const now = ctx.currentTime;
      g.gain.cancelScheduledValues(now);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.12, now + 0.01);
      o.start(now);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.6);
      o.stop(now + 0.65);
      setTimeout(()=>{ try{ ctx.close(); }catch(e){} }, 800);
    } catch(e) {}
  }

  startPauseBtn.addEventListener('click', () => {
    if (!running && !paused) {
      startTimer();
      startPauseBtn.textContent = 'Pause';
    } else if (running && !paused) {
      pauseTimer();
    } else if (!running && paused) {
      resumeTimer();
    }
  });

  restartBtn.addEventListener('click', () => {
    restartTimer();
  });

  goBtn.addEventListener('click', () => {
    window.location.href = '/breaks';
  });

  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      updateTimerUI();
    }
  });

  timerEl.textContent = fmt(remainingMs);
  goBtn.style.display = 'none';
  goBtn.disabled = true;

  window.FOCUSHIVE_TIMER_READY = true;

})();

</script>

<style>
    .fh-title {
  text-align: center;
  color: #0b6ed1;
  margin: 10px 0;
  font-weight: 700;
  font-size: 28px;
}

.fh-wrapper {
  display: flex;
  justify-content: center;
  margin-top: 20px;
}

.fh-card {
  width: 400px;
  background: #ffffffcc;
  border-radius: 18px;
  padding: 30px 32px;
  box-shadow: 0 8px 25px rgba(33, 150, 243, 0.12);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.timer-circle {
  width: 220px;
  height: 220px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  color: #0d47a1;
  border: 8px solid #64b5f6;
  background: radial-gradient(circle, #e3f7ff 0%, #ccecff 100%);
  box-shadow: inset 0 0 18px rgba(100,181,246,0.25);
}

.control-buttons {
  display: flex;
  justify-content: center;
  gap: 24px; 
  margin-top: 4px;
}

.control-buttons button {
  background: linear-gradient(135deg, #42a5f5, #64b5f6);
  color: #fff;
  border: none;
  padding: 10px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(66,165,245,0.25);
}

.next-link-row button {
  background: linear-gradient(135deg, #0077cc, #42a5f5);
  color: #fff;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}

.next-link-row button:disabled {
  opacity: 0.45;
  cursor: not-allowed;
}
</style>

{% endblock %}